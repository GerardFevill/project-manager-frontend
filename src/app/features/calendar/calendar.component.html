<div class="calendar-container">
  <div class="header">
    <h1>üìÖ Calendrier des T√¢ches</h1>
    <button mat-raised-button color="primary" routerLink="/tasks">
      <mat-icon>arrow_back</mat-icon>
      Retour aux t√¢ches
    </button>
  </div>

  @if (loading()) {
    <div class="loading">Chargement du calendrier...</div>
  } @else {
    <!-- Filtres par type -->
    <mat-card class="filter-card">
      <h3>Afficher :</h3>
      <div class="filter-checkboxes">
        <mat-checkbox [(ngModel)]="showTasks" (change)="onFilterChange()" class="filter-checkbox">
          <mat-icon class="filter-icon" [style.color]="'#1976d2'">check_circle</mat-icon>
          T√¢ches
        </mat-checkbox>
        <mat-checkbox [(ngModel)]="showProjects" (change)="onFilterChange()" class="filter-checkbox">
          <mat-icon class="filter-icon" [style.color]="'#7b1fa2'">folder</mat-icon>
          Projets
        </mat-checkbox>
        <mat-checkbox [(ngModel)]="showEpics" (change)="onFilterChange()" class="filter-checkbox">
          <mat-icon class="filter-icon" [style.color]="'#f57c00'">workspaces</mat-icon>
          Epics
        </mat-checkbox>
        <mat-checkbox [(ngModel)]="showMilestones" (change)="onFilterChange()" class="filter-checkbox">
          <mat-icon class="filter-icon" [style.color]="'#388e3c'">flag</mat-icon>
          Jalons
        </mat-checkbox>
      </div>
    </mat-card>

    <!-- Navigation du calendrier -->
    <mat-card class="calendar-nav">
      <div class="nav-controls">
        <button mat-icon-button (click)="previousMonth()" matTooltip="Mois pr√©c√©dent">
          <mat-icon>chevron_left</mat-icon>
        </button>

        <h2 class="month-title">{{ getMonthName() }}</h2>

        <button mat-icon-button (click)="nextMonth()" matTooltip="Mois suivant">
          <mat-icon>chevron_right</mat-icon>
        </button>

        <button mat-raised-button (click)="goToToday()" class="today-btn">
          Aujourd'hui
        </button>
      </div>
    </mat-card>

    <!-- Calendrier -->
    <mat-card class="calendar-card">
      <!-- Jours de la semaine -->
      <div class="calendar-grid">
        @for (day of weekDays; track day) {
          <div class="weekday-header">{{ day }}</div>
        }

        <!-- Jours du mois -->
        @for (calendarDay of calendarDays(); track calendarDay.date) {
          <div
            class="calendar-day"
            [class.today]="calendarDay.isToday"
            [class.other-month]="!calendarDay.isCurrentMonth"
            [class.has-tasks]="calendarDay.tasks.length > 0">

            <div class="day-number">
              {{ calendarDay.date.getDate() }}
            </div>

            @if (calendarDay.tasks.length > 0) {
              <div class="day-tasks">
                @for (task of calendarDay.tasks.slice(0, 3); track task.id) {
                  <a [routerLink]="['/tasks', task.id]"
                     class="task-item"
                     [class]="'task-item-' + task.type"
                     [matTooltip]="task.title + ' (' + task.type + ')'">
                    <mat-icon class="task-icon-small">{{ getTypeIcon(task.type) }}</mat-icon>
                    <span class="task-title">{{ task.title }}</span>
                  </a>
                }
                @if (calendarDay.tasks.length > 3) {
                  <div class="more-tasks">
                    +{{ calendarDay.tasks.length - 3 }} autre(s)
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    </mat-card>

    <!-- L√©gende am√©lior√©e -->
    <mat-card class="legend-card">
      <h3>Types d'√©l√©ments</h3>
      <div class="legend-items">
        <div class="legend-item" [class.legend-disabled]="!showTasks">
          <mat-icon class="legend-icon" [style.color]="showTasks ? '#1976d2' : '#999'">check_circle</mat-icon>
          <div class="legend-text">
            <span class="legend-label">T√¢che</span>
            <span class="legend-desc">Unit√© de travail de base</span>
          </div>
        </div>
        <div class="legend-item" [class.legend-disabled]="!showProjects">
          <mat-icon class="legend-icon" [style.color]="showProjects ? '#7b1fa2' : '#999'">folder</mat-icon>
          <div class="legend-text">
            <span class="legend-label">Projet</span>
            <span class="legend-desc">Conteneur de t√¢ches</span>
          </div>
        </div>
        <div class="legend-item" [class.legend-disabled]="!showEpics">
          <mat-icon class="legend-icon" [style.color]="showEpics ? '#f57c00' : '#999'">workspaces</mat-icon>
          <div class="legend-text">
            <span class="legend-label">Epic</span>
            <span class="legend-desc">Groupe de t√¢ches</span>
          </div>
        </div>
        <div class="legend-item" [class.legend-disabled]="!showMilestones">
          <mat-icon class="legend-icon" [style.color]="showMilestones ? '#388e3c' : '#999'">flag</mat-icon>
          <div class="legend-text">
            <span class="legend-label">Jalon</span>
            <span class="legend-desc">√âtape importante</span>
          </div>
        </div>
      </div>
    </mat-card>
  }
</div>
