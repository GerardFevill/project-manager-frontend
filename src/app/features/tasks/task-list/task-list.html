<div class="task-list-container">
  <div class="header">
    <h1>Project Manager</h1>
    <button mat-raised-button color="primary" (click)="openCreateTaskDialog()">
      <mat-icon>add</mat-icon>
      New Task
    </button>
  </div>

  <!-- Filters -->
  <div class="filters">
    <mat-form-field appearance="outline">
      <mat-label>Statut</mat-label>
      <mat-select [(ngModel)]="filters.status" (selectionChange)="loadTasks()">
        <mat-option value="all">Toutes les tâches</mat-option>
        <mat-option [value]="TaskStatus.DRAFT">Brouillon</mat-option>
        <mat-option [value]="TaskStatus.ACTIVE">Actives</mat-option>
        <mat-option [value]="TaskStatus.COMPLETED">Terminées</mat-option>
        <mat-option [value]="TaskStatus.BLOCKED">Bloquées</mat-option>
        <mat-option [value]="TaskStatus.RECURRING">Récurrentes</mat-option>
        <mat-option [value]="TaskStatus.ARCHIVED">Archivées</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Priorité</mat-label>
      <mat-select [(ngModel)]="filters.priority" (selectionChange)="loadTasks()">
        <mat-option [value]="undefined">Toutes les priorités</mat-option>
        <mat-option value="low">Faible</mat-option>
        <mat-option value="medium">Moyenne</mat-option>
        <mat-option value="high">Haute</mat-option>
        <mat-option value="urgent">Urgente</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-checkbox [(ngModel)]="filters.onlyRoot" (change)="loadTasks()">
      Tâches racines uniquement
    </mat-checkbox>
  </div>

  <!-- Task Table -->
  <div class="table-container">
    @if (loading()) {
      <div class="loading">Chargement des tâches...</div>
    } @else if (tasks().length === 0) {
      <div class="empty">Aucune tâche trouvée. Créez votre première tâche !</div>
    } @else {
      <table mat-table [dataSource]="tasks()" matSort (matSortChange)="sortData($event)" class="tasks-table">

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Statut</th>
          <td mat-cell *matCellDef="let task">
            <app-task-status-badge [status]="task.status"></app-task-status-badge>
          </td>
        </ng-container>

        <!-- Title Column -->
        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Titre</th>
          <td mat-cell *matCellDef="let task">
            <div class="title-cell" [class.overdue]="isOverdue(task)">
              {{ task.title }}
              @if (isOverdue(task)) {
                <mat-icon class="overdue-icon" matTooltip="En retard">warning</mat-icon>
              }
            </div>
          </td>
        </ng-container>

        <!-- Progress Column -->
        <ng-container matColumnDef="progress">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Progression</th>
          <td mat-cell *matCellDef="let task">
            <div class="progress-cell">
              <app-task-progress-bar [progress]="task.progress"></app-task-progress-bar>
            </div>
          </td>
        </ng-container>

        <!-- Priority Column -->
        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Priorité</th>
          <td mat-cell *matCellDef="let task">
            <span class="priority priority-{{ task.priority }}">
              {{ task.priority }}
            </span>
          </td>
        </ng-container>

        <!-- Tags Column -->
        <ng-container matColumnDef="tags">
          <th mat-header-cell *matHeaderCellDef>Tags</th>
          <td mat-cell *matCellDef="let task">
            <div class="tags-cell">
              @if (task.tags && task.tags.length > 0) {
                <mat-chip-set>
                  @for (tag of task.tags.slice(0, 2); track tag) {
                    <mat-chip>{{ tag }}</mat-chip>
                  }
                  @if (task.tags.length > 2) {
                    <mat-chip>+{{ task.tags.length - 2 }}</mat-chip>
                  }
                </mat-chip-set>
              } @else {
                <span class="no-tags">-</span>
              }
            </div>
          </td>
        </ng-container>

        <!-- Due Date Column -->
        <ng-container matColumnDef="dueDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Échéance</th>
          <td mat-cell *matCellDef="let task">
            <div [class.overdue-date]="isOverdue(task)">
              {{ task.dueDate ? (task.dueDate | date:'short') : '-' }}
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let task">
            <button mat-icon-button [matMenuTriggerFor]="actionMenu" matTooltip="Actions">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #actionMenu="matMenu">
              <button mat-menu-item [routerLink]="['/tasks', task.id]">
                <mat-icon>visibility</mat-icon>
                <span>Voir les détails</span>
              </button>

              @if (task.status === TaskStatus.COMPLETED) {
                <button mat-menu-item (click)="toggleTask(task.id)">
                  <mat-icon>undo</mat-icon>
                  <span>Marquer comme active</span>
                </button>
              } @else {
                <button mat-menu-item (click)="toggleTask(task.id)">
                  <mat-icon>check_circle</mat-icon>
                  <span>Marquer comme terminée</span>
                </button>
              }

              <button mat-menu-item (click)="editTask(task)">
                <mat-icon>edit</mat-icon>
                <span>Modifier</span>
              </button>

              @if (task.status === TaskStatus.BLOCKED) {
                <button mat-menu-item (click)="unblockTask(task.id)">
                  <mat-icon>lock_open</mat-icon>
                  <span>Débloquer</span>
                </button>
              } @else {
                <button mat-menu-item (click)="blockTask(task)">
                  <mat-icon>block</mat-icon>
                  <span>Bloquer</span>
                </button>
              }

              @if (task.status === TaskStatus.ARCHIVED) {
                <button mat-menu-item (click)="unarchiveTask(task.id)">
                  <mat-icon>unarchive</mat-icon>
                  <span>Restaurer</span>
                </button>
              } @else {
                <button mat-menu-item (click)="archiveTask(task.id)">
                  <mat-icon>archive</mat-icon>
                  <span>Archiver</span>
                </button>
              }

              <button mat-menu-item (click)="duplicateTask(task)">
                <mat-icon>content_copy</mat-icon>
                <span>Dupliquer</span>
              </button>

              @if (task.children && task.children.length > 0) {
                <button mat-menu-item (click)="viewChildren(task.id)">
                  <mat-icon>subdirectory_arrow_right</mat-icon>
                  <span>Voir les sous-tâches ({{ task.children.length }})</span>
                </button>
              }

              <mat-divider></mat-divider>
              <button mat-menu-item (click)="deleteTask(task.id)" class="delete-menu-item">
                <mat-icon>delete</mat-icon>
                <span>Supprimer</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            [class.blocked-row]="row.status === TaskStatus.BLOCKED"
            [class.archived-row]="row.status === TaskStatus.ARCHIVED"></tr>
      </table>
    }
  </div>
</div>
