<div class="task-detail-container">
  @if (loading()) {
    <div class="loading">
      <p>Chargement des détails...</p>
    </div>
  } @else if (task()) {
    <!-- Header with actions -->
    <div class="detail-header">
      <button mat-icon-button routerLink="/tasks" matTooltip="Retour à la liste">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h1>
        @if (task()!.type === 'project') {
          <mat-icon class="header-type-icon project-icon">folder</mat-icon>
          Détails du projet
        } @else if (task()!.type === 'epic') {
          <mat-icon class="header-type-icon epic-icon">workspaces</mat-icon>
          Détails de l'epic
        } @else if (task()!.type === 'milestone') {
          <mat-icon class="header-type-icon milestone-icon">flag</mat-icon>
          Détails du jalon
        } @else {
          <mat-icon class="header-type-icon task-icon">check_circle</mat-icon>
          Détails de la tâche
        }
      </h1>
      <div class="header-actions">
        <button mat-icon-button [matMenuTriggerFor]="actionMenu" matTooltip="Actions">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #actionMenu="matMenu">
          <button mat-menu-item (click)="editTask()">
            <mat-icon>edit</mat-icon>
            <span>Modifier</span>
          </button>
          @if (task()!.status === TaskStatus.BLOCKED) {
            <button mat-menu-item (click)="unblockTask()">
              <mat-icon>lock_open</mat-icon>
              <span>Débloquer</span>
            </button>
          } @else {
            <button mat-menu-item (click)="blockTask()">
              <mat-icon>block</mat-icon>
              <span>Bloquer</span>
            </button>
          }
          <button mat-menu-item (click)="archiveTask()">
            <mat-icon>archive</mat-icon>
            <span>Archiver</span>
          </button>
          @if (task()!.type !== 'project' && task()!.type !== 'milestone') {
            <button mat-menu-item (click)="convertToProject()">
              <mat-icon>folder</mat-icon>
              <span>Convertir en projet</span>
            </button>
          }
          <mat-divider></mat-divider>
          <button mat-menu-item (click)="deleteTask()" class="delete-menu-item">
            <mat-icon>delete</mat-icon>
            <span>Supprimer</span>
          </button>
        </mat-menu>
      </div>
    </div>

    <!-- Main content with tabs -->
    <mat-tab-group class="detail-tabs" (selectedIndexChange)="onTabChange($event)">
      <!-- Tab 1: Details (existing content) -->
      <mat-tab label="Détails">
        <ng-template matTabContent>
          <div class="detail-content">
      <!-- Title and Status Card -->
      <mat-card class="title-card">
        <mat-card-header>
          <div class="title-header">
            <h2>{{ task()!.title }}</h2>
            <div class="badges">
              <app-task-status-badge [status]="task()!.status"></app-task-status-badge>
              <app-task-type-badge [type]="task()!.type"></app-task-type-badge>
            </div>
          </div>
        </mat-card-header>
        <mat-card-content>
          @if (task()!.description) {
            <p class="description">{{ task()!.description }}</p>
          } @else {
            <p class="no-description">Aucune description</p>
          }
        </mat-card-content>
      </mat-card>

      <!-- Two columns layout -->
      <div class="columns">
        <!-- Left column - Main info -->
        <div class="left-column">
          <!-- Progress Card -->
          <mat-card>
            <mat-card-header>
              <mat-card-title>Progression</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <app-task-progress-bar [progress]="task()!.progress"></app-task-progress-bar>
              <p class="progress-text">{{ task()!.progress }}% complété</p>

              <button
                mat-raised-button
                color="primary"
                (click)="toggleTask()"
                class="toggle-btn"
              >
                @if (task()!.status === TaskStatus.COMPLETED) {
                  <ng-container>
                    <mat-icon>undo</mat-icon>
                    Marquer comme active
                  </ng-container>
                } @else {
                  <ng-container>
                    <mat-icon>check_circle</mat-icon>
                    Marquer comme terminée
                  </ng-container>
                }
              </button>
            </mat-card-content>
          </mat-card>

          <!-- Details Card -->
          <mat-card>
            <mat-card-header>
              <mat-card-title>Informations</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-grid">
                <div class="info-item">
                  <mat-icon>flag</mat-icon>
                  <div>
                    <span class="info-label">Priorité</span>
                    <span class="priority priority-{{ task()!.priority }}">
                      {{ task()!.priority }}
                    </span>
                  </div>
                </div>

                <div class="info-item">
                  <mat-icon>layers</mat-icon>
                  <div>
                    <span class="info-label">Niveau</span>
                    <span class="info-value">Niveau {{ task()!.level }}</span>
                  </div>
                </div>

                @if (task()!.dueDate) {
                  <div class="info-item" [class.overdue]="isOverdue(task()!)">
                    <mat-icon>event</mat-icon>
                    <div>
                      <span class="info-label">Échéance</span>
                      <span class="info-value">{{ formatDate(task()!.dueDate) }}</span>
                      @if (isOverdue(task()!)) {
                        <span class="overdue-badge">En retard</span>
                      }
                    </div>
                  </div>
                }

                @if (task()!.startDate) {
                  <div class="info-item">
                    <mat-icon>play_arrow</mat-icon>
                    <div>
                      <span class="info-label">Date de début</span>
                      <span class="info-value">{{ formatDate(task()!.startDate) }}</span>
                    </div>
                  </div>
                }

                @if (task()!.recurrence && task()!.recurrence !== 'none') {
                  <div class="info-item">
                    <mat-icon>repeat</mat-icon>
                    <div>
                      <span class="info-label">Récurrence</span>
                      <span class="info-value">{{ task()!.recurrence }}</span>
                    </div>
                  </div>
                }

                @if (task()!.nextOccurrence) {
                  <div class="info-item">
                    <mat-icon>schedule</mat-icon>
                    <div>
                      <span class="info-label">Prochaine occurrence</span>
                      <span class="info-value">{{ formatDateTime(task()!.nextOccurrence) }}</span>
                    </div>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Time Tracking Card -->
          @if (task()!.estimatedHours || task()!.actualHours) {
            <mat-card>
              <mat-card-header>
                <mat-card-title>Suivi du temps</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="time-tracking">
                  @if (task()!.estimatedHours) {
                    <div class="time-item">
                      <mat-icon>schedule</mat-icon>
                      <span class="time-label">Estimé :</span>
                      <span class="time-value">{{ task()!.estimatedHours }}h</span>
                    </div>
                  }
                  @if (task()!.actualHours) {
                    <div class="time-item">
                      <mat-icon>timer</mat-icon>
                      <span class="time-label">Réel :</span>
                      <span class="time-value">{{ task()!.actualHours }}h</span>
                    </div>
                  }
                  @if (task()!.estimatedHours && task()!.actualHours) {
                    <div class="time-item">
                      <mat-icon>trending_up</mat-icon>
                      <span class="time-label">Écart :</span>
                      <span class="time-value"
                            [class.over-budget]="task()!.actualHours! > task()!.estimatedHours!">
                        {{ (task()!.actualHours! - task()!.estimatedHours!).toFixed(1) }}h
                      </span>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          }
        </div>

        <!-- Right column - Tags, Dates, Metadata -->
        <div class="right-column">
          <!-- Tags Card -->
          @if (task()!.tags && task()!.tags.length > 0) {
            <mat-card>
              <mat-card-header>
                <mat-card-title>Tags</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-chip-set>
                  @for (tag of task()!.tags; track tag) {
                    <mat-chip>{{ tag }}</mat-chip>
                  }
                </mat-chip-set>
              </mat-card-content>
            </mat-card>
          }

          <!-- Metadata Card -->
          @if (task()!.metadata) {
            <mat-card>
              <mat-card-header>
                <mat-card-title>Métadonnées</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="metadata">
                  @for (entry of task()!.metadata | keyvalue; track entry.key) {
                    <div class="metadata-item">
                      <span class="metadata-key">{{ entry.key }}</span>
                      <span class="metadata-value">{{ entry.value }}</span>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          }

          <!-- Timestamps Card -->
          <mat-card>
            <mat-card-header>
              <mat-card-title>Historique</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="timestamps">
                <div class="timestamp-item">
                  <mat-icon>add_circle</mat-icon>
                  <div>
                    <span class="timestamp-label">Créée le</span>
                    <span class="timestamp-value">{{ formatDateTime(task()!.createdAt) }}</span>
                  </div>
                </div>
                <div class="timestamp-item">
                  <mat-icon>update</mat-icon>
                  <div>
                    <span class="timestamp-label">Modifiée le</span>
                    <span class="timestamp-value">{{ formatDateTime(task()!.updatedAt) }}</span>
                  </div>
                </div>
                @if (task()!.completedAt) {
                  <div class="timestamp-item">
                    <mat-icon>check_circle</mat-icon>
                    <div>
                      <span class="timestamp-label">Terminée le</span>
                      <span class="timestamp-value">{{ formatDateTime(task()!.completedAt) }}</span>
                    </div>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Hierarchy Card -->
          @if (task()!.parent || (task()!.children && task()!.children!.length > 0)) {
            <mat-card>
              <mat-card-header>
                <mat-card-title>Hiérarchie</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                @if (task()!.parent) {
                  <div class="hierarchy-item">
                    <mat-icon>arrow_upward</mat-icon>
                    <span>Tâche parente : {{ task()!.parent!.title }}</span>
                  </div>
                }
                @if (task()!.children && task()!.children!.length > 0) {
                  <div class="hierarchy-item">
                    <mat-icon>arrow_downward</mat-icon>
                    <span>{{ task()!.children!.length }} sous-tâche(s)</span>
                  </div>
                }
              </mat-card-content>
            </mat-card>
          }
        </div>
      </div>
          </div>
        </ng-template>
      </mat-tab>

      <!-- Tab 2: History -->
      <mat-tab label="Historique">
        <ng-template matTabContent>
          <div class="tab-content">
            @if (loadingHistory()) {
              <div class="loading-tab">
                <mat-icon>hourglass_empty</mat-icon>
                <p>Chargement de l'historique...</p>
              </div>
            } @else if (history().length === 0) {
              <div class="empty-tab">
                <mat-icon>history</mat-icon>
                <p>Aucun historique disponible pour cette tâche.</p>
              </div>
            } @else {
              <mat-card class="history-card">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>history</mat-icon>
                    Historique des actions
                  </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="history-timeline">
                    @for (entry of history(); track entry.id) {
                      <div class="history-item">
                        <div class="history-dot"></div>
                        <div class="history-content">
                          <div class="history-header">
                            <span class="history-action">{{ entry.action }}</span>
                            <span class="history-date">{{ formatDateTime(entry.executedAt) }}</span>
                          </div>
                          <div class="history-details">
                            <div class="history-detail-item">
                              <mat-icon>flag</mat-icon>
                              <span>Statut: <strong>{{ entry.statusAtExecution }}</strong></span>
                            </div>
                            <div class="history-detail-item">
                              <mat-icon>show_chart</mat-icon>
                              <span>Progression: <strong>{{ entry.progressAtExecution }}%</strong></span>
                            </div>
                            @if (entry.duration) {
                              <div class="history-detail-item">
                                <mat-icon>schedule</mat-icon>
                                <span>Durée: <strong>{{ entry.duration }}ms</strong></span>
                              </div>
                            }
                            @if (entry.metadata) {
                              <div class="history-metadata">
                                <mat-icon>info</mat-icon>
                                <span>Métadonnées:</span>
                                <div class="metadata-content">
                                  @for (meta of entry.metadata | keyvalue; track meta.key) {
                                    <div class="metadata-pair">
                                      <span class="meta-key">{{ meta.key }}:</span>
                                      <span class="meta-value">{{ meta.value }}</span>
                                    </div>
                                  }
                                </div>
                              </div>
                            }
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </mat-card-content>
              </mat-card>
            }
          </div>
        </ng-template>
      </mat-tab>

      <!-- Tab 3: Progress Timeline -->
      <mat-tab label="Timeline">
        <ng-template matTabContent>
          <div class="tab-content">
            @if (loadingProgress()) {
              <div class="loading-tab">
                <mat-icon>hourglass_empty</mat-icon>
                <p>Chargement de la timeline...</p>
              </div>
            } @else if (!progress()) {
              <div class="empty-tab">
                <mat-icon>timeline</mat-icon>
                <p>Aucune donnée de progression disponible.</p>
              </div>
            } @else {
              <!-- Current Progress Card -->
              <mat-card class="progress-card">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>trending_up</mat-icon>
                    Progression actuelle
                  </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <app-task-progress-bar [progress]="progress()!.currentProgress"></app-task-progress-bar>
                  <p class="progress-value">{{ progress()!.currentProgress }}% complété</p>
                </mat-card-content>
              </mat-card>

              <!-- Children Progress Card -->
              @if (progress()!.childrenProgress && progress()!.childrenProgress!.length > 0) {
                <mat-card class="children-progress-card">
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>account_tree</mat-icon>
                      Progression des sous-tâches
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="children-list">
                      @for (child of progress()!.childrenProgress; track child.id) {
                        <div class="child-item">
                          <span class="child-title">{{ child.title }}</span>
                          <div class="child-progress">
                            <app-task-progress-bar [progress]="child.progress"></app-task-progress-bar>
                            <span class="child-percentage">{{ child.progress }}%</span>
                          </div>
                        </div>
                      }
                    </div>
                  </mat-card-content>
                </mat-card>
              }

              <!-- Timeline Card -->
              @if (progress()!.timeline && progress()!.timeline!.length > 0) {
                <mat-card class="timeline-card">
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>timeline</mat-icon>
                      Historique de progression
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="progress-timeline">
                      @for (event of progress()!.timeline; track $index) {
                        <div class="timeline-item">
                          <div class="timeline-dot"></div>
                          <div class="timeline-content">
                            <div class="timeline-header">
                              <span class="timeline-action">{{ event.action }}</span>
                              <span class="timeline-date">{{ formatDate(event.date) }}</span>
                            </div>
                            <div class="timeline-progress">
                              <app-task-progress-bar [progress]="event.progress"></app-task-progress-bar>
                              <span class="timeline-percentage">{{ event.progress }}%</span>
                            </div>
                          </div>
                        </div>
                      }
                    </div>
                  </mat-card-content>
                </mat-card>
              }
            }
          </div>
        </ng-template>
      </mat-tab>
    </mat-tab-group>
  }
</div>
