<div class="jira-issue-view">
  @if (loading()) {
    <div class="loading-state">
      <mat-icon class="loading-icon">hourglass_empty</mat-icon>
      <p>Loading issue...</p>
    </div>
  } @else if (task()) {
    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb-bar">
      <a routerLink="/projects" class="breadcrumb-link">
        <mat-icon>folder_open</mat-icon>
        <span>Projects</span>
      </a>
      <mat-icon class="breadcrumb-sep">chevron_right</mat-icon>
      <a routerLink="/kanban" class="breadcrumb-link">
        <span>Board</span>
      </a>
      @if (task()!.parent) {
        <mat-icon class="breadcrumb-sep">chevron_right</mat-icon>
        <a [routerLink]="['/tasks', task()!.parent!.id]" class="breadcrumb-link">
          <span>{{ task()!.parent!.title }}</span>
        </a>
      }
    </div>

    <!-- Issue Header -->
    <div class="issue-header">
      <div class="issue-meta">
        <div class="issue-type" [style.background-color]="getIssueTypeColor(task()!.issueType)">
          <mat-icon>{{ getIssueTypeIcon(task()!.issueType) }}</mat-icon>
        </div>
        <span class="issue-key">TASK-{{ task()!.id.slice(0, 6).toUpperCase() }}</span>
      </div>
      <div class="issue-actions">
        <button mat-icon-button matTooltip="Give feedback">
          <mat-icon>feedback</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Watch">
          <mat-icon>visibility_off</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Vote">
          <mat-icon>thumb_up</mat-icon>
        </button>
        <button mat-icon-button [matMenuTriggerFor]="moreMenu">
          <mat-icon>more_horiz</mat-icon>
        </button>
        <mat-menu #moreMenu="matMenu">
          <button mat-menu-item (click)="editTask()">
            <mat-icon>edit</mat-icon>
            <span>Edit</span>
          </button>
          @if (task()!.status === TaskStatus.BLOCKED) {
            <button mat-menu-item (click)="unblockTask()">
              <mat-icon>lock_open</mat-icon>
              <span>Unblock</span>
            </button>
          } @else {
            <button mat-menu-item (click)="blockTask()">
              <mat-icon>block</mat-icon>
              <span>Block</span>
            </button>
          }
          <button mat-menu-item (click)="archiveTask()">
            <mat-icon>archive</mat-icon>
            <span>Archive</span>
          </button>
          <button mat-menu-item (click)="convertToProject()">
            <mat-icon>transform</mat-icon>
            <span>Convert to project</span>
          </button>
          <mat-divider></mat-divider>
          <button mat-menu-item (click)="deleteTask()" class="delete-item">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
        </mat-menu>
      </div>
    </div>

    <!-- Issue Title -->
    <h1 class="issue-title">{{ task()!.title }}</h1>

    <!-- Two Column Layout -->
    <div class="issue-content">
      <!-- Main Column -->
      <div class="main-column">
        <!-- Description Section -->
        <div class="detail-section">
          <div class="section-header">
            <span class="section-title">Description</span>
            <button mat-icon-button matTooltip="Edit" (click)="editTask()">
              <mat-icon>edit</mat-icon>
            </button>
          </div>
          <div class="section-content">
            @if (task()!.description) {
              <p class="description-text">{{ task()!.description }}</p>
            } @else {
              <p class="empty-description">Add a description...</p>
            }
          </div>
        </div>

        <!-- Activity Section -->
        <div class="detail-section">
          <div class="section-header">
            <span class="section-title">Activity</span>
            <div class="activity-filters">
              <button mat-button class="filter-btn" [class.active]="activeFilter() === 'all'" (click)="setFilter('all')">
                All
              </button>
              <button mat-button class="filter-btn" [class.active]="activeFilter() === 'comments'" (click)="setFilter('comments')">
                Comments ({{ comments().length }})
              </button>
              <button mat-button class="filter-btn" [class.active]="activeFilter() === 'history'" (click)="setFilter('history')">
                History
              </button>
            </div>
          </div>
          <div class="section-content">
            <!-- Add Comment -->
            @if (activeFilter() === 'all' || activeFilter() === 'comments') {
              <div class="add-comment">
                <app-user-avatar [user]="currentUser()" size="medium"></app-user-avatar>
                <div class="comment-input-wrapper">
                  <textarea
                    [(ngModel)]="newCommentContent"
                    class="comment-input"
                    placeholder="Add a comment..."
                    rows="3"
                  ></textarea>
                  <div class="comment-actions">
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="addComment()"
                      [disabled]="!newCommentContent.trim() || savingComment()">
                      {{ savingComment() ? 'Saving...' : 'Save' }}
                    </button>
                    <button mat-button (click)="newCommentContent = ''" [disabled]="savingComment()">
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            }

            <!-- Comments List -->
            @if (activeFilter() === 'all' || activeFilter() === 'comments') {
              @if (loadingComments()) {
                <div class="loading-comments">
                  <mat-icon>hourglass_empty</mat-icon>
                  <p>Loading comments...</p>
                </div>
              } @else if (comments().length > 0) {
                <div class="comments-list">
                  @for (comment of comments(); track comment.id) {
                    <app-task-comment
                      [comment]="comment"
                      [canEdit]="canEditComment(comment)"
                      (edit)="updateComment($event)"
                      (delete)="deleteComment($event)">
                    </app-task-comment>
                  }
                </div>
              } @else {
                <div class="empty-comments">
                  <mat-icon>chat_bubble_outline</mat-icon>
                  <p>No comments yet. Be the first to comment!</p>
                </div>
              }
            }

            <!-- History Timeline -->
            @if (activeFilter() === 'all' || activeFilter() === 'history') {
              @if (history().length > 0) {
                <div class="activity-timeline">
                  @for (entry of history(); track entry.id) {
                    <div class="activity-item">
                      <app-user-avatar [user]="null" size="small"></app-user-avatar>
                      <div class="activity-content">
                        <div class="activity-header">
                          <span class="activity-author">System</span>
                          <span class="activity-action">{{ entry.action }}</span>
                          <span class="activity-time">{{ formatDateTime(entry.executedAt) }}</span>
                        </div>
                        <div class="activity-details">
                          <span>Status: {{ entry.statusAtExecution }}</span>
                          <span>Progress: {{ entry.progressAtExecution }}%</span>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-activity">
                  <mat-icon>history</mat-icon>
                  <p>No history yet</p>
                </div>
              }
            }
          </div>
        </div>
      </div>

      <!-- Sidebar Column -->
      <div class="sidebar-column">
        <!-- Details Panel -->
        <div class="sidebar-section">
          <div class="sidebar-item">
            <label class="sidebar-label">Status</label>
            <app-task-status-badge [status]="task()!.status"></app-task-status-badge>
          </div>

          <div class="sidebar-item">
            <label class="sidebar-label">Assignee</label>
            @if (task()!.assignee) {
              <div class="assignee-display">
                <app-user-avatar [user]="task()!.assignee || null" size="small"></app-user-avatar>
                <span class="assignee-name">{{ task()!.assignee?.firstName }} {{ task()!.assignee?.lastName }}</span>
              </div>
            } @else {
              <button mat-button class="assign-btn">
                <mat-icon>add</mat-icon>
                Assign
              </button>
            }
          </div>

          <div class="sidebar-item">
            <label class="sidebar-label">Reporter</label>
            <div class="reporter-display">
              <app-user-avatar [user]="null" size="small"></app-user-avatar>
              <span class="reporter-name">Unassigned</span>
            </div>
          </div>

          <div class="sidebar-item">
            <label class="sidebar-label">Priority</label>
            <div class="priority-display priority-{{ task()!.priority }}">
              <mat-icon>flag</mat-icon>
              <span>{{ task()!.priority === 'low' ? 'Low' :
                       task()!.priority === 'medium' ? 'Medium' :
                       task()!.priority === 'high' ? 'High' : 'Urgent' }}</span>
            </div>
          </div>

          @if (task()!.tags && task()!.tags.length > 0) {
            <div class="sidebar-item">
              <label class="sidebar-label">Labels</label>
              <div class="labels-display">
                @for (tag of task()!.tags; track tag) {
                  <mat-chip class="label-chip">{{ tag }}</mat-chip>
                }
              </div>
            </div>
          }

          @if (task()!.startDate) {
            <div class="sidebar-item">
              <label class="sidebar-label">Start date</label>
              <div class="date-display">
                <mat-icon>play_arrow</mat-icon>
                <span>{{ formatDate(task()!.startDate) }}</span>
              </div>
            </div>
          }

          @if (task()!.dueDate) {
            <div class="sidebar-item">
              <label class="sidebar-label">Due date</label>
              <div class="date-display" [class.overdue]="isOverdue(task()!)">
                <mat-icon>event</mat-icon>
                <span>{{ formatDate(task()!.dueDate) }}</span>
              </div>
            </div>
          }

          <div class="sidebar-item">
            <label class="sidebar-label">Time tracking</label>
            <div class="time-tracking-widget">
              @if (loadingTimeSummary()) {
                <div class="time-loading">
                  <mat-icon>hourglass_empty</mat-icon>
                  <span>Loading...</span>
                </div>
              } @else {
                <!-- Progress Bar -->
                @if ((task()?.estimatedHours ?? 0) > 0) {
                  <div class="time-progress-bar">
                    <div class="time-progress-fill" [style.width.%]="getTimePercentage()"></div>
                  </div>
                  <div class="time-stats">
                    <span class="time-logged">{{ formatTimeHours(timeSummary().totalLogged) }}</span>
                    <span class="time-separator">/</span>
                    <span class="time-estimated">{{ task()!.estimatedHours }}h</span>
                  </div>
                } @else {
                  <div class="time-no-estimate">
                    <div class="time-stats-single">
                      <mat-icon>schedule</mat-icon>
                      <span class="time-logged">{{ formatTimeHours(timeSummary().totalLogged) }} logged</span>
                    </div>
                    <span class="time-hint">No time estimate</span>
                  </div>
                }

                <!-- Log Work Button -->
                <button mat-stroked-button class="log-work-btn" (click)="openLogWorkDialog()">
                  <mat-icon>add</mat-icon>
                  Log Work
                </button>

                <!-- Work Logs List -->
                @if (workLogs().length > 0) {
                  <div class="work-logs-section">
                    <div class="work-logs-header" (click)="toggleWorkLogs()">
                      <span>Work logs ({{ workLogs().length }})</span>
                      <mat-icon>{{ showWorkLogs() ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </div>
                    @if (showWorkLogs()) {
                      <div class="work-logs-list">
                        @for (log of workLogs(); track log.id) {
                          <div class="work-log-item">
                            <div class="work-log-header">
                              <app-user-avatar [user]="log.user || null" size="small"></app-user-avatar>
                              <div class="work-log-info">
                                <span class="work-log-user">{{ log.user ? (log.user.firstName + ' ' + log.user.lastName) : 'Unknown' }}</span>
                                <span class="work-log-time">{{ formatTimeHours(log.timeSpent) }}</span>
                              </div>
                              @if (canEditWorkLog(log)) {
                                <button mat-icon-button [matMenuTriggerFor]="logMenu" class="work-log-menu">
                                  <mat-icon>more_horiz</mat-icon>
                                </button>
                                <mat-menu #logMenu="matMenu">
                                  <button mat-menu-item (click)="editWorkLog(log)">
                                    <mat-icon>edit</mat-icon>
                                    <span>Edit</span>
                                  </button>
                                  <button mat-menu-item (click)="deleteWorkLog(log.id)">
                                    <mat-icon>delete</mat-icon>
                                    <span>Delete</span>
                                  </button>
                                </mat-menu>
                              }
                            </div>
                            <div class="work-log-date">{{ formatWorkDate(log.workDate) }}</div>
                            @if (log.description) {
                              <div class="work-log-description">{{ log.description }}</div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              }
            </div>
          </div>
        </div>

        <!-- Progress Section -->
        <div class="sidebar-section">
          <div class="sidebar-item">
            <label class="sidebar-label">Progress</label>
            <div class="progress-display">
              <app-task-progress-bar [progress]="task()!.progress"></app-task-progress-bar>
              <span class="progress-value">{{ task()!.progress }}%</span>
            </div>
          </div>
        </div>

        <!-- Dates Section -->
        <div class="sidebar-section">
          <div class="sidebar-item-small">
            <span class="meta-label">Created</span>
            <span class="meta-value">{{ formatDate(task()!.createdAt) }}</span>
          </div>
          <div class="sidebar-item-small">
            <span class="meta-label">Updated</span>
            <span class="meta-value">{{ formatDate(task()!.updatedAt) }}</span>
          </div>
          @if (task()!.completedAt) {
            <div class="sidebar-item-small">
              <span class="meta-label">Completed</span>
              <span class="meta-value">{{ formatDate(task()!.completedAt) }}</span>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
