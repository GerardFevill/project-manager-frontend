<div class="sprint-planning-container">
  <!-- Header -->
  <div class="planning-header">
    <div class="header-left">
      <button mat-icon-button (click)="router.navigate(['/kanban'])" matTooltip="Retour au Board">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <mat-icon class="header-icon">event_note</mat-icon>
      <h1>Sprint Planning</h1>
    </div>

    <div class="header-actions">
      <button mat-stroked-button (click)="openSprintDialog()">
        <mat-icon>add</mat-icon>
        Nouveau sprint
      </button>
    </div>
  </div>

  <!-- Sprint Selector -->
  @if (sprints().length > 0) {
    <div class="sprint-selector-section">
      <mat-form-field appearance="outline" class="sprint-select">
        <mat-label>Sprint à planifier</mat-label>
        <mat-select
          [value]="selectedSprint()?.id"
          (selectionChange)="onSprintSelectChange($event.value)">
          @for (sprint of sprints(); track sprint.id) {
            <mat-option [value]="sprint.id">
              <div class="sprint-option">
                <mat-icon>sprint</mat-icon>
                <span class="sprint-name">{{ sprint.name }}</span>
                <span class="sprint-dates">{{ sprint.startDate | date:'dd MMM' }} - {{ sprint.endDate | date:'dd MMM' }}</span>
              </div>
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      @if (selectedSprint()) {
        <button mat-icon-button (click)="openSprintDialog(selectedSprint()!)" matTooltip="Modifier le sprint">
          <mat-icon>edit</mat-icon>
        </button>
      }
    </div>
  }

  <!-- Empty State - No Sprints -->
  @if (sprints().length === 0 && !loading()) {
    <div class="empty-state-main">
      <mat-icon>event_note</mat-icon>
      <h2>Aucun sprint planifié</h2>
      <p>Créez un sprint pour commencer la planification</p>
      <button mat-raised-button color="primary" (click)="openSprintDialog()">
        <mat-icon>add</mat-icon>
        Créer un sprint
      </button>
    </div>
  }

  <!-- Planning Board -->
  @if (selectedSprint() && !loading()) {
    <div class="planning-board" cdkDropListGroup>
      <!-- Backlog Column -->
      <div class="planning-column backlog-column">
        <div class="column-header">
          <div class="header-title">
            <mat-icon>inventory_2</mat-icon>
            <h2>Backlog</h2>
            <span class="count">{{ backlogTasks().length }}</span>
          </div>
          <p class="column-description">Glissez les tâches vers le sprint</p>
        </div>

        <div
          class="column-content"
          cdkDropList
          id="backlog"
          [cdkDropListData]="backlogTasks()"
          (cdkDropListDropped)="drop($event, 'backlog')">

          @if (backlogTasks().length === 0) {
            <div class="empty-state">
              <mat-icon>inbox</mat-icon>
              <p>Backlog vide</p>
            </div>
          }

          @for (task of backlogTasks(); track task.id) {
            <div class="task-card" cdkDrag [attr.data-priority]="task.priority">
              <div class="priority-indicator" [style.background-color]="getPriorityColor(task.priority)"></div>

              <div class="task-content" (click)="openTaskDetail(task.id)">
                <div class="task-header">
                  <div class="task-type">
                    <mat-icon class="type-icon" [style.color]="getTypeColor(task.issueType)">{{ getTypeIcon(task.issueType) }}</mat-icon>
                    <span class="task-id">{{ task.id }}</span>
                  </div>
                  <mat-icon
                    class="priority-icon"
                    [style.color]="getPriorityColor(task.priority)"
                    [matTooltip]="task.priority">
                    {{ getPriorityIcon(task.priority) }}
                  </mat-icon>
                </div>

                <h4 class="task-title">{{ task.title }}</h4>

                <div class="task-meta">
                  @if (task.estimatedHours) {
                    <div class="meta-item">
                      <mat-icon>schedule</mat-icon>
                      <span>{{ task.estimatedHours }}h</span>
                    </div>
                  }
                  @if (task.dueDate) {
                    <div class="meta-item">
                      <mat-icon>event</mat-icon>
                      <span>{{ task.dueDate | date:'dd MMM' }}</span>
                    </div>
                  }
                </div>

                <!-- Task Footer: Tags + Assignee -->
                <div class="task-footer">
                  @if (task.tags && task.tags.length > 0) {
                    <div class="task-tags">
                      @for (tag of task.tags.slice(0, 2); track tag) {
                        <span class="tag">{{ tag }}</span>
                      }
                    </div>
                  }

                  @if (task.assignee) {
                    <app-user-avatar [user]="task.assignee" size="small" class="task-assignee"></app-user-avatar>
                  }
                </div>
              </div>

              <div class="drag-handle" cdkDragHandle>
                <mat-icon>drag_indicator</mat-icon>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Sprint Column -->
      <div class="planning-column sprint-column">
        <div class="column-header">
          <div class="header-title">
            <mat-icon>sprint</mat-icon>
            <h2>{{ selectedSprint()!.name }}</h2>
            <span class="count">{{ taskCount() }}</span>
          </div>

          <div class="sprint-stats">
            <div class="stat-item">
              <mat-icon>schedule</mat-icon>
              <span>{{ totalEstimatedHours() }}h estimées</span>
            </div>
            <div class="stat-item">
              <mat-icon>task</mat-icon>
              <span>{{ taskCount() }} tâches</span>
            </div>
          </div>

          @if (selectedSprint()!.goal) {
            <p class="sprint-goal">
              <mat-icon>flag</mat-icon>
              {{ selectedSprint()!.goal }}
            </p>
          }
        </div>

        <div
          class="column-content sprint-drop-zone"
          cdkDropList
          id="sprint"
          [cdkDropListData]="sprintTasks()"
          (cdkDropListDropped)="drop($event, 'sprint')">

          @if (sprintTasks().length === 0) {
            <div class="empty-state sprint-empty">
              <mat-icon>sprint</mat-icon>
              <p>Glissez des tâches ici</p>
              <span class="hint">Planifiez votre sprint en glissant des tâches depuis le backlog</span>
            </div>
          }

          @for (task of sprintTasks(); track task.id) {
            <div class="task-card" cdkDrag [attr.data-priority]="task.priority">
              <div class="priority-indicator" [style.background-color]="getPriorityColor(task.priority)"></div>

              <div class="task-content" (click)="openTaskDetail(task.id)">
                <div class="task-header">
                  <div class="task-type">
                    <mat-icon class="type-icon" [style.color]="getTypeColor(task.issueType)">{{ getTypeIcon(task.issueType) }}</mat-icon>
                    <span class="task-id">{{ task.id }}</span>
                  </div>
                  <mat-icon
                    class="priority-icon"
                    [style.color]="getPriorityColor(task.priority)"
                    [matTooltip]="task.priority">
                    {{ getPriorityIcon(task.priority) }}
                  </mat-icon>
                </div>

                <h4 class="task-title">{{ task.title }}</h4>

                <div class="task-meta">
                  @if (task.estimatedHours) {
                    <div class="meta-item">
                      <mat-icon>schedule</mat-icon>
                      <span>{{ task.estimatedHours }}h</span>
                    </div>
                  }
                  @if (task.dueDate) {
                    <div class="meta-item">
                      <mat-icon>event</mat-icon>
                      <span>{{ task.dueDate | date:'dd MMM' }}</span>
                    </div>
                  }
                </div>

                <!-- Task Footer: Tags + Assignee -->
                <div class="task-footer">
                  @if (task.tags && task.tags.length > 0) {
                    <div class="task-tags">
                      @for (tag of task.tags.slice(0, 2); track tag) {
                        <span class="tag">{{ tag }}</span>
                      }
                    </div>
                  }

                  @if (task.assignee) {
                    <app-user-avatar [user]="task.assignee" size="small" class="task-assignee"></app-user-avatar>
                  }
                </div>
              </div>

              <div class="drag-handle" cdkDragHandle>
                <mat-icon>drag_indicator</mat-icon>
              </div>
            </div>
          }
        </div>

        <!-- Actions -->
        <div class="column-footer">
          <button
            mat-raised-button
            color="primary"
            (click)="startSprint()"
            [disabled]="sprintTasks().length === 0">
            <mat-icon>play_arrow</mat-icon>
            Démarrer le sprint
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading">
      <mat-icon class="loading-icon">hourglass_empty</mat-icon>
      <p>Chargement...</p>
    </div>
  }
</div>
