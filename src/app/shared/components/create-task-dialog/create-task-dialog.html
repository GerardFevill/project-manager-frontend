<div class="dialog-header">
  <h2 mat-dialog-title>
    <mat-icon>{{ data ? 'edit' : 'add_task' }}</mat-icon>
    {{ data ? 'Modifier la tâche' : 'Créer une nouvelle tâche' }}
  </h2>
  <span class="required-indicator">* Champs requis</span>
</div>

<mat-dialog-content>
  <div class="form-content">
    <!-- Section: Informations de base -->
    <mat-expansion-panel expanded>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>info</mat-icon>
          Informations de base
        </mat-panel-title>
      </mat-expansion-panel-header>

      <!-- Title -->
      <mat-form-field appearance="outline">
        <mat-label>Titre <span class="required">*</span></mat-label>
        <mat-icon matIconPrefix>title</mat-icon>
        <input matInput [(ngModel)]="taskData.title" required placeholder="Ex: Implémenter la fonctionnalité X" />
        <mat-hint>Nom clair et descriptif de la tâche</mat-hint>
      </mat-form-field>

      <!-- Description -->
      <mat-form-field appearance="outline">
        <mat-label>Description</mat-label>
        <mat-icon matIconPrefix>description</mat-icon>
        <textarea matInput [(ngModel)]="taskData.description" rows="4" placeholder="Description détaillée de la tâche..."></textarea>
        <mat-hint>Détails, objectifs, contexte</mat-hint>
      </mat-form-field>

      <!-- Type & Parent -->
      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Type <span class="required">*</span></mat-label>
          <mat-select [(ngModel)]="taskData.type">
            <mat-option [value]="TaskType.TASK">
              <mat-icon [style.color]="'#1976d2'">{{ getTypeIcon(TaskType.TASK) }}</mat-icon>
              Tâche
            </mat-option>
            <mat-option [value]="TaskType.PROJECT">
              <mat-icon [style.color]="'#7b1fa2'">{{ getTypeIcon(TaskType.PROJECT) }}</mat-icon>
              Projet
            </mat-option>
            <mat-option [value]="TaskType.EPIC">
              <mat-icon [style.color]="'#f57c00'">{{ getTypeIcon(TaskType.EPIC) }}</mat-icon>
              Epic
            </mat-option>
            <mat-option [value]="TaskType.MILESTONE">
              <mat-icon [style.color]="'#388e3c'">{{ getTypeIcon(TaskType.MILESTONE) }}</mat-icon>
              Jalon
            </mat-option>
          </mat-select>
          <mat-hint>Type d'élément</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tâche parente</mat-label>
          <mat-icon matIconPrefix>account_tree</mat-icon>
          <mat-select [(ngModel)]="taskData.parentId">
            <mat-option [value]="undefined">Aucune (racine)</mat-option>
            @for (parent of availableParents(); track parent.id) {
              <mat-option [value]="parent.id">
                <mat-icon [style.color]="parent.type === 'project' ? '#7b1fa2' : '#f57c00'" class="option-icon">
                  {{ getTypeIcon(parent.type) }}
                </mat-icon>
                {{ parent.title }}
              </mat-option>
            }
          </mat-select>
          <mat-hint>Attacher à un projet ou epic existant</mat-hint>
        </mat-form-field>
      </div>
    </mat-expansion-panel>

    <mat-divider></mat-divider>

    <!-- Section: Statut et priorité -->
    <mat-expansion-panel expanded>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>label</mat-icon>
          Statut et priorité
        </mat-panel-title>
      </mat-expansion-panel-header>

      <!-- Status & Priority -->
      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Statut</mat-label>
          <mat-icon matIconPrefix>radio_button_checked</mat-icon>
          <mat-select [(ngModel)]="taskData.status">
            <mat-option [value]="TaskStatus.DRAFT">
              <mat-icon color="accent">drafts</mat-icon>
              Brouillon
            </mat-option>
            <mat-option [value]="TaskStatus.ACTIVE">
              <mat-icon style="color: #2196f3">play_arrow</mat-icon>
              Active
            </mat-option>
            <mat-option [value]="TaskStatus.COMPLETED">
              <mat-icon style="color: #4caf50">check_circle</mat-icon>
              Terminée
            </mat-option>
            <mat-option [value]="TaskStatus.BLOCKED">
              <mat-icon style="color: #f44336">block</mat-icon>
              Bloquée
            </mat-option>
            <mat-option [value]="TaskStatus.RECURRING">
              <mat-icon style="color: #9c27b0">loop</mat-icon>
              Récurrente
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Priorité</mat-label>
          <mat-icon matIconPrefix>flag</mat-icon>
          <mat-select [(ngModel)]="taskData.priority">
            <mat-option value="low">
              <mat-icon style="color: #4caf50">arrow_downward</mat-icon>
              Faible
            </mat-option>
            <mat-option value="medium">
              <mat-icon style="color: #ff9800">drag_handle</mat-icon>
              Moyenne
            </mat-option>
            <mat-option value="high">
              <mat-icon style="color: #f44336">arrow_upward</mat-icon>
              Haute
            </mat-option>
            <mat-option value="urgent">
              <mat-icon style="color: #d32f2f">priority_high</mat-icon>
              Urgente
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Progress Slider -->
      <div class="progress-section">
        <label class="field-label">
          <mat-icon>trending_up</mat-icon>
          Progression: {{ taskData.progress }}%
        </label>
        <mat-slider
          min="0"
          max="100"
          step="5"
          discrete
          [displayWith]="formatLabel"
        >
          <input matSliderThumb [(ngModel)]="taskData.progress">
        </mat-slider>
      </div>
    </mat-expansion-panel>

    <mat-divider></mat-divider>

    <!-- Section: Planification -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>schedule</mat-icon>
          Planification
        </mat-panel-title>
      </mat-expansion-panel-header>

      <!-- Dates -->
      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Date de début</mat-label>
          <mat-icon matIconPrefix>event</mat-icon>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="taskData.startDate" />
          <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
          <mat-hint>Quand commencer</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date d'échéance</mat-label>
          <mat-icon matIconPrefix>event_available</mat-icon>
          <input matInput [matDatepicker]="duePicker" [(ngModel)]="taskData.dueDate" />
          <mat-datepicker-toggle matIconSuffix [for]="duePicker"></mat-datepicker-toggle>
          <mat-datepicker #duePicker></mat-datepicker>
          <mat-hint>Date limite</mat-hint>
        </mat-form-field>
      </div>

      <!-- Time tracking -->
      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Heures estimées</mat-label>
          <mat-icon matIconPrefix>schedule</mat-icon>
          <input matInput type="number" [(ngModel)]="taskData.estimatedHours" min="0" step="0.5" placeholder="8" />
          <mat-hint>Temps prévu (heures)</mat-hint>
        </mat-form-field>

        @if (data) {
          <mat-form-field appearance="outline">
            <mat-label>Heures réelles</mat-label>
            <mat-icon matIconPrefix>timer</mat-icon>
            <input matInput type="number" [(ngModel)]="taskData.actualHours" min="0" step="0.5" placeholder="6.5" />
            <mat-hint>Temps réellement passé</mat-hint>
          </mat-form-field>
        }
      </div>

      <!-- Recurrence -->
      <app-task-recurrence-selector
        [(ngModel)]="taskData.recurrence"
      ></app-task-recurrence-selector>

      @if (taskData.recurrence && taskData.recurrence !== TaskRecurrence.NONE) {
        <mat-form-field appearance="outline">
          <mat-label>Prochaine occurrence</mat-label>
          <mat-icon matIconPrefix>repeat</mat-icon>
          <input matInput type="datetime-local" [(ngModel)]="taskData.nextOccurrence" />
          <mat-hint>Date/heure de la prochaine occurrence</mat-hint>
        </mat-form-field>
      }
    </mat-expansion-panel>

    <mat-divider></mat-divider>

    <!-- Section: Organisation -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>label</mat-icon>
          Tags et métadonnées
        </mat-panel-title>
      </mat-expansion-panel-header>

      <!-- Tags -->
      <app-task-tags-input
        [(ngModel)]="taskData.tags"
      ></app-task-tags-input>
    </mat-expansion-panel>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button [mat-dialog-close]="null">
    <mat-icon>close</mat-icon>
    Annuler
  </button>
  <button
    mat-raised-button
    color="primary"
    (click)="onSubmit()"
    [disabled]="!isFormValid()"
    [matTooltip]="!isFormValid() ? 'Veuillez remplir tous les champs requis' : ''">
    <mat-icon>{{ data ? 'save' : 'add' }}</mat-icon>
    {{ data ? 'Modifier' : 'Créer' }}
  </button>
</mat-dialog-actions>
